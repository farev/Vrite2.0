<!DOCTYPE html>
<html>
<head>
  <title>JWT Debug Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #005a9e;
    }
    #output {
      background: #252526;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      margin-top: 20px;
      border: 1px solid #3e3e42;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    .info { color: #9cdcfe; }
  </style>
</head>
<body>
  <h1>JWT Authentication Debugger</h1>
  <button onclick="testFullFlow()">üîç Run Full Diagnostic</button>
  <button onclick="testEdgeFunction()">üöÄ Test Edge Function Only</button>
  <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
  <div id="output">Click "Run Full Diagnostic" to start...</div>

  <script type="module">
    const output = document.getElementById('output');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    window.clearOutput = function() {
      output.innerHTML = '';
    };

    window.testFullFlow = async function() {
      clearOutput();
      log('=== STARTING FULL JWT DIAGNOSTIC ===', 'info');
      log('', 'info');

      try {
        // Step 1: Import Supabase client
        log('Step 1: Importing Supabase client...', 'info');
        const { createClient } = await import('http://localhost:3001/src/lib/supabase/client.js');
        const supabase = createClient();
        log('‚úÖ Supabase client created', 'success');
        log('', 'info');

        // Step 2: Get session
        log('Step 2: Getting session...', 'info');
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          log('‚ùå Session error: ' + sessionError.message, 'error');
          return;
        }

        if (!session) {
          log('‚ùå No session found! You need to log in first.', 'error');
          log('   Go to http://localhost:3001 and log in with Google', 'warning');
          return;
        }

        log('‚úÖ Session found!', 'success');
        log('   User: ' + session.user.email, 'info');
        log('   User ID: ' + session.user.id, 'info');
        log('', 'info');

        // Step 3: Check token
        log('Step 3: Checking access token...', 'info');
        const token = session.access_token;
        log('   Token length: ' + token.length + ' characters', 'info');
        log('   Token prefix: ' + token.substring(0, 30) + '...', 'info');
        
        // Check expiry
        if (session.expires_at) {
          const now = Math.floor(Date.now() / 1000);
          const expiresAt = session.expires_at;
          const expiresIn = expiresAt - now;
          const expiresInMinutes = Math.floor(expiresIn / 60);
          
          log('   Expires at: ' + new Date(expiresAt * 1000).toLocaleString(), 'info');
          log('   Expires in: ' + expiresInMinutes + ' minutes', 'info');
          
          if (expiresIn < 0) {
            log('   ‚ö†Ô∏è  TOKEN IS EXPIRED!', 'error');
            log('   Attempting to refresh...', 'warning');
            
            const { data: { session: newSession }, error: refreshError } = await supabase.auth.refreshSession();
            
            if (refreshError || !newSession) {
              log('   ‚ùå Failed to refresh: ' + (refreshError?.message || 'Unknown error'), 'error');
              log('   SOLUTION: Log out and log back in', 'warning');
              return;
            }
            
            log('   ‚úÖ Token refreshed successfully!', 'success');
            session.access_token = newSession.access_token;
          } else {
            log('   ‚úÖ Token is valid and not expired', 'success');
          }
        }
        log('', 'info');

        // Step 4: Validate token with Supabase
        log('Step 4: Validating token with Supabase...', 'info');
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError) {
          log('‚ùå Token validation failed: ' + userError.message, 'error');
          log('   Error name: ' + userError.name, 'error');
          log('   Error status: ' + (userError.status || 'N/A'), 'error');
          return;
        }

        if (!user) {
          log('‚ùå No user returned from validation', 'error');
          return;
        }

        log('‚úÖ Token is valid!', 'success');
        log('   Validated user: ' + user.email, 'info');
        log('', 'info');

        // Step 5: Test Edge Function
        log('Step 5: Testing Edge Function call...', 'info');
        const supabaseUrl = 'https://qkdrjsylfnravzhnlvcy.supabase.co';
        const endpoint = `${supabaseUrl}/functions/v1/ai-command`;
        
        log('   Endpoint: ' + endpoint, 'info');
        log('   Sending test request...', 'info');

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            content: 'Test content for debugging',
            instruction: 'Make this bold',
          }),
        });

        log('   Response status: ' + response.status + ' ' + response.statusText, 'info');
        
        const responseText = await response.text();
        log('   Response body: ' + responseText, 'info');
        log('', 'info');

        if (response.ok) {
          log('‚úÖ‚úÖ‚úÖ SUCCESS! Edge Function call worked!', 'success');
          log('', 'info');
          log('The JWT authentication is working correctly.', 'success');
          log('If you\'re still seeing errors in the app, the issue is elsewhere.', 'warning');
        } else {
          log('‚ùå Edge Function call failed!', 'error');
          log('', 'info');
          
          // Try to parse error
          try {
            const errorJson = JSON.parse(responseText);
            log('Error details:', 'error');
            log('   Code: ' + (errorJson.code || 'N/A'), 'error');
            log('   Message: ' + (errorJson.message || errorJson.error || 'N/A'), 'error');
            
            if (errorJson.message === 'Invalid JWT' || errorJson.message?.includes('JWT')) {
              log('', 'info');
              log('üîç DIAGNOSIS: The token is being rejected by the Edge Function', 'warning');
              log('', 'info');
              log('Possible causes:', 'warning');
              log('1. Edge Function environment variables are incorrect', 'warning');
              log('2. JWT secret mismatch between client and server', 'warning');
              log('3. Token format issue in the Edge Function code', 'warning');
              log('', 'info');
              log('Next steps:', 'info');
              log('1. Check Supabase Dashboard > Settings > API for correct keys', 'info');
              log('2. Verify Edge Function has SUPABASE_URL and SUPABASE_ANON_KEY set', 'info');
              log('3. Check Edge Function logs in Supabase Dashboard', 'info');
            }
          } catch (e) {
            log('   Raw error: ' + responseText, 'error');
          }
        }

      } catch (error) {
        log('', 'info');
        log('‚ùå EXCEPTION OCCURRED:', 'error');
        log('   ' + error.message, 'error');
        log('   ' + error.stack, 'error');
      }

      log('', 'info');
      log('=== DIAGNOSTIC COMPLETE ===', 'info');
    };

    window.testEdgeFunction = async function() {
      clearOutput();
      log('=== TESTING EDGE FUNCTION ONLY ===', 'info');
      
      try {
        const { createClient } = await import('http://localhost:3001/src/lib/supabase/client.js');
        const supabase = createClient();
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
          log('‚ùå Not logged in', 'error');
          return;
        }

        log('Calling Edge Function...', 'info');
        const response = await fetch('https://qkdrjsylfnravzhnlvcy.supabase.co/functions/v1/ai-command', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            content: 'Quick test',
            instruction: 'Make bold',
          }),
        });

        log('Status: ' + response.status, response.ok ? 'success' : 'error');
        const text = await response.text();
        log('Response: ' + text, response.ok ? 'success' : 'error');
      } catch (error) {
        log('Error: ' + error.message, 'error');
      }
    };
  </script>
</body>
</html>
