<!DOCTYPE html>
<html>
<head>
  <title>Simple JWT Test</title>
</head>
<body>
  <h1>Simple JWT Test</h1>
  <button onclick="runTest()">Run Test</button>
  <pre id="output"></pre>

  <script>
    async function runTest() {
      console.clear();
      console.log('=== JWT DIAGNOSTIC TEST ===\n');

      try {
        // Get all cookies
        const cookies = document.cookie.split(';').reduce((acc, cookie) => {
          const [key, value] = cookie.trim().split('=');
          acc[key] = value;
          return acc;
        }, {});

        // Find auth cookie
        const authCookieKey = Object.keys(cookies).find(key => 
          key.includes('sb-') && key.includes('-auth-token')
        );

        if (!authCookieKey) {
          console.error('âŒ No auth cookie found');
          console.log('Available cookies:', Object.keys(cookies));
          return;
        }

        console.log('âœ… Auth cookie found');
        
        let cookieValue = decodeURIComponent(cookies[authCookieKey]);
        console.log('Raw cookie value (first 50 chars):', cookieValue.substring(0, 50));

        // Handle base64- prefix if present
        if (cookieValue.startsWith('base64-')) {
          console.log('ðŸ” Detected base64- prefix, decoding...');
          const base64Data = cookieValue.substring(7); // Remove 'base64-' prefix
          
          try {
            // Decode base64
            const decodedString = atob(base64Data);
            console.log('âœ… Base64 decoded successfully');
            console.log('Decoded string (first 100 chars):', decodedString.substring(0, 100));
            
            // Parse as JSON
            const sessionData = JSON.parse(decodedString);
            console.log('âœ… Parsed as JSON successfully');
            console.log('Session data keys:', Object.keys(sessionData));
            
            if (sessionData.access_token) {
              console.log('âœ… Access token found!');
              console.log('Token length:', sessionData.access_token.length);
              console.log('Token prefix:', sessionData.access_token.substring(0, 30) + '...');
              
              // Decode JWT to check contents
              const tokenParts = sessionData.access_token.split('.');
              if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                console.log('âœ… JWT decoded successfully');
                console.log('JWT payload:', payload);
                console.log('User ID:', payload.sub);
                console.log('Email:', payload.email);
                console.log('Expires:', new Date(payload.exp * 1000).toLocaleString());
              }
            } else {
              console.error('âŒ No access_token in session data');
            }
          } catch (decodeError) {
            console.error('âŒ Failed to decode base64:', decodeError.message);
          }
        } else {
          // Try parsing directly as JSON
          try {
            const sessionData = JSON.parse(cookieValue);
            console.log('âœ… Parsed as JSON directly (no base64 prefix)');
            console.log('Session data:', sessionData);
          } catch (parseError) {
            console.error('âŒ Failed to parse as JSON:', parseError.message);
            console.log('Cookie value might be in unexpected format');
          }
        }

      } catch (error) {
        console.error('\nâŒ Exception:', error.message);
        console.error(error);
      }

      console.log('\n=== TEST COMPLETE ===');
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      document.getElementById('output').textContent = 'Click "Run Test" button or check browser console';
    });
  </script>
</body>
</html>
