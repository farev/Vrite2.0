<!DOCTYPE html>
<html>
<head>
  <title>Test Supabase Client</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
      max-width: 1200px;
      margin: 0 auto;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #005a9e;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #output {
      background: #252526;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      margin-top: 20px;
      border: 1px solid #3e3e42;
      max-height: 600px;
      overflow-y: auto;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    .info { color: #9cdcfe; }
    h1 { color: #569cd6; }
    .section { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>üîç Supabase Client Test</h1>
  
  <div class="section">
    <button onclick="testSupabaseClient()">Test Supabase Client</button>
    <button onclick="testEdgeFunction()">Test Edge Function</button>
    <button onclick="clearOutput()">Clear Output</button>
  </div>

  <div id="output">Click "Test Supabase Client" to start...</div>

  <script type="module">
    const output = document.getElementById('output');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    window.clearOutput = function() {
      output.innerHTML = '';
    };

    window.testSupabaseClient = async function() {
      clearOutput();
      log('=== TESTING SUPABASE CLIENT ===\n', 'info');

      try {
        log('Step 1: Importing Supabase client...', 'info');
        const { createClient } = await import('/src/lib/supabase/client.js');
        const supabase = createClient();
        log('‚úÖ Supabase client created', 'success');
        log('', 'info');

        log('Step 2: Getting session...', 'info');
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          log('‚ùå Session error: ' + sessionError.message, 'error');
          return;
        }

        if (!session) {
          log('‚ùå No session found!', 'error');
          log('   You need to log in first at http://localhost:3001/login', 'warning');
          return;
        }

        log('‚úÖ Session retrieved successfully!', 'success');
        log('   User: ' + session.user.email, 'info');
        log('   User ID: ' + session.user.id, 'info');
        log('', 'info');

        log('Step 3: Checking access token...', 'info');
        const token = session.access_token;
        log('   Token length: ' + token.length + ' characters', 'info');
        log('   Token prefix: ' + token.substring(0, 50) + '...', 'info');
        
        // Decode JWT
        const tokenParts = token.split('.');
        if (tokenParts.length === 3) {
          let payload64 = tokenParts[1];
          const paddingNeeded = (4 - (payload64.length % 4)) % 4;
          if (paddingNeeded > 0) {
            payload64 += '='.repeat(paddingNeeded);
          }
          
          const payload = JSON.parse(atob(payload64));
          log('   Issued at: ' + new Date(payload.iat * 1000).toLocaleString(), 'info');
          log('   Expires at: ' + new Date(payload.exp * 1000).toLocaleString(), 'info');
          
          const now = Math.floor(Date.now() / 1000);
          const expiresIn = payload.exp - now;
          const minutesLeft = Math.floor(expiresIn / 60);
          
          if (expiresIn < 0) {
            log('   ‚ö†Ô∏è  TOKEN IS EXPIRED!', 'error');
          } else {
            log('   ‚úÖ Token is valid (' + minutesLeft + ' minutes remaining)', 'success');
          }
        }
        log('', 'info');

        log('Step 4: Validating token with Supabase...', 'info');
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        
        if (userError) {
          log('‚ùå Token validation failed: ' + userError.message, 'error');
          return;
        }

        if (!user) {
          log('‚ùå No user returned from validation', 'error');
          return;
        }

        log('‚úÖ Token validated successfully!', 'success');
        log('   Validated user: ' + user.email, 'info');
        log('', 'info');

        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
        log('‚úÖ‚úÖ‚úÖ SUPABASE CLIENT IS WORKING! ‚úÖ‚úÖ‚úÖ', 'success');
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');

      } catch (error) {
        log('', 'info');
        log('‚ùå EXCEPTION:', 'error');
        log('   ' + error.message, 'error');
        if (error.stack) {
          log('   Stack: ' + error.stack, 'error');
        }
      }

      log('', 'info');
      log('=== TEST COMPLETE ===', 'info');
    };

    window.testEdgeFunction = async function() {
      clearOutput();
      log('=== TESTING EDGE FUNCTION ===\n', 'info');

      try {
        log('Step 1: Getting session...', 'info');
        const { createClient } = await import('/src/lib/supabase/client.js');
        const supabase = createClient();
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError || !session) {
          log('‚ùå Not logged in or session error', 'error');
          return;
        }

        log('‚úÖ Session found for: ' + session.user.email, 'success');
        log('', 'info');

        log('Step 2: Calling Edge Function...', 'info');
        const endpoint = 'https://qkdrjsylfnravzhnlvcy.supabase.co/functions/v1/ai-command';
        log('   Endpoint: ' + endpoint, 'info');

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            content: 'Test content for debugging',
            instruction: 'Make this text bold',
          }),
        });

        log('   Response status: ' + response.status + ' ' + response.statusText, 'info');
        
        const responseText = await response.text();
        log('', 'info');

        if (response.ok) {
          log('‚úÖ‚úÖ‚úÖ EDGE FUNCTION CALL SUCCESSFUL! ‚úÖ‚úÖ‚úÖ', 'success');
          log('', 'info');
          log('Response:', 'info');
          try {
            const data = JSON.parse(responseText);
            log(JSON.stringify(data, null, 2), 'info');
          } catch {
            log(responseText, 'info');
          }
        } else {
          log('‚ùå Edge Function call failed!', 'error');
          log('Response:', 'error');
          log(responseText, 'error');
        }

      } catch (error) {
        log('', 'info');
        log('‚ùå EXCEPTION:', 'error');
        log('   ' + error.message, 'error');
      }

      log('', 'info');
      log('=== TEST COMPLETE ===', 'info');
    };
  </script>
</body>
</html>
