<!DOCTYPE html>
<html>
<head>
  <title>Supabase Edge Function Diagnostic</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .warning { color: orange; font-weight: bold; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #0070f3; color: white; border: none; border-radius: 5px; }
    button:disabled { background: #ccc; }
  </style>
</head>
<body>
  <h1>Supabase Edge Function Diagnostic</h1>
  <p>This tool will test your connection to the Supabase Edge Function and diagnose JWT issues.</p>
  
  <button id="runBtn">Run Diagnostic</button>
  <div id="results"></div>

  <script type="module">
    const runBtn = document.getElementById('runBtn');
    const results = document.getElementById('results');

    function log(msg, type = '') {
      const div = document.createElement('div');
      if (type) div.className = type;
      div.innerHTML = msg;
      results.appendChild(div);
    }

    function logPre(obj) {
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(obj, null, 2);
      results.appendChild(pre);
    }

    runBtn.addEventListener('click', async () => {
      runBtn.disabled = true;
      results.innerHTML = '<h3>Running diagnostic...</h3>';

      try {
        // 1. Check Env Vars
        log('<b>1. Checking Environment Variables...</b>');
        const supabaseUrl = 'https://qkdrjsylfnravzhnlvcy.supabase.co';
        const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZHJqc3lsZm5yYXZ6aG5sdmN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDQ2NjUsImV4cCI6MjA4MzM4MDY2NX0.75D-cvfvoRTtYZO5rBzkIqRuAxvOan8HPML86aP_lnw';
        
        log(`Supabase URL: ${supabaseUrl}`);
        log(`Anon Key Prefix: ${anonKey.substring(0, 20)}...`);

        // 2. Import Supabase
        log('<br><b>2. Importing Supabase Client...</b>');
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        const supabase = createClient(supabaseUrl, anonKey);
        log('✅ Supabase client created', 'success');

        // 3. Get Session
        log('<br><b>3. Getting Current Session...</b>');
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          log(`❌ Session Error: ${sessionError.message}`, 'error');
          return;
        }

        if (!session) {
          log('❌ No session found! Please log in to the app first.', 'error');
          return;
        }

        log('✅ Session found', 'success');
        log(`User: ${session.user.email}`);
        log(`Access Token Prefix: ${session.access_token.substring(0, 20)}...`);

        // 4. Inspect JWT
        log('<br><b>4. Inspecting Access Token...</b>');
        const parts = session.access_token.split('.');
        if (parts.length !== 3) {
          log('❌ Invalid JWT format (missing parts)', 'error');
        } else {
          try {
            const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
            logPre(payload);
            
            if (payload.ref !== 'qkdrjsylfnravzhnlvcy') {
              log(`❌ Project Ref Mismatch! Token is for ${payload.ref}, but you are calling qkdrjsylfnravzhnlvcy`, 'error');
            } else {
              log('✅ Project Ref matches', 'success');
            }

            const now = Math.floor(Date.now() / 1000);
            if (payload.exp < now) {
              log('❌ Token is EXPIRED!', 'error');
            } else {
              log(`✅ Token expires in ${Math.floor((payload.exp - now) / 60)} minutes`, 'success');
            }
          } catch (e) {
            log(`❌ Could not decode payload: ${e.message}`, 'error');
          }
        }

        // 5. Test Edge Function
        log('<br><b>5. Testing Edge Function (ai-command)...</b>');
        const endpoint = `${supabaseUrl}/functions/v1/ai-command`;
        log(`Endpoint: ${endpoint}`);

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'apikey': anonKey,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            content: 'Test content',
            instruction: 'Make this bold',
          }),
        });

        log(`Response Status: ${response.status} ${response.statusText}`);
        
        const responseText = await response.text();
        try {
          const json = JSON.parse(responseText);
          log('Response JSON:');
          logPre(json);
          
          if (response.ok) {
            log('✅✅✅ DIAGNOSTIC SUCCESSFUL! ✅✅✅', 'success');
          } else {
            log('❌ Request failed', 'error');
            if (json.message === 'Invalid JWT') {
              log('<br><b>DEDUCTION:</b> The Supabase gateway is rejecting your token.', 'warning');
              log('This usually means the <b>JWT_SECRET</b> in your Supabase project does not match the secret used to sign the token.', 'warning');
              log('Since this is a cloud project, this should not happen unless you changed settings manually.', 'warning');
              log('<br>Try logging out and logging in again to get a fresh token.', 'warning');
            }
          }
        } catch (e) {
          log('Response Text:');
          log(responseText);
        }

      } catch (err) {
        log(`❌ Unexpected Error: ${err.message}`, 'error');
        console.error(err);
      } finally {
        runBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
